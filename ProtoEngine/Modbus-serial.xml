<?xml version="1.0" encoding="utf-8"?>
<protocol name="Modbus-RTU">
  <options>
    <option name="crc_check" type="bool"/>
  </options>
<!-- Do przemyÅ›lenia kiedy indziej
  <types>
    <type name="server_address" base="byte"/>
  </types> -->
  <msg_start_mark>
    <field type="silence" value="3.5"/>
  </msg_start_mark>
  <msgs>
    <msg type="request" name="base">
      <block name="needs_crc">
        <field name="address" type="byte"/>
        <find_device/>
        <field name="function_code" type="byte"/>
        <inc_msg/>
      </block>
      <field name="crc" type="word"/>
      <conditional>
        <match variable="crc_check" value="yes"/>
        <set name="my_crc" value="(crc $needs_crc)"/>
        <assert variable="my_crc" value="$crc" err_msg="Bad CRC!"/>
      </conditional>
    </msg>
    <msg type="response" name="base">
      <block name="do_crc">
        <field name="address" type="byte" default="$address"/>
        <inc_msg/>
      </block>
      <field name="crc" value="(crc $do_crc)"/>
    </msg>
    <msg type="response" name="mb_excep_rsp_pdu">
      <field name="exception-function_code" type="byte" default="(| $function_code 0x80)"/>
      <field name="exception_code" type="byte"/>
    </msg>

    <msg type="response" name="mb_rsp_pdu">
      <field name="function_code" type="byte"/>
      <inc_msg/>
    </msg>

    <msg type="request" name="read_coils_req">
      <match variable="function_code" value="1"/>
      <field name="starting_address" type="word"/>
      <field name="quantity_of_coils" type="word"/>
      <conditional>
        <match_expr>(gt $quantity_of_coils 2000)</match_expr>
        <warning>Too many coils!</warning>
        <set name="exception_code" value="3"/>
      </conditional>
    </msg>
    <msg type="response" name="read_coils_resp">
      <match name="function_code" value="1"/>
      <field name="byte_count" type="word"/>
      <field name="coil_status" type="array byte $byte_count"/>
    </msg>
    
  </msgs>

  <devices>
    <device name="Coil thingy">
      <options>
        <option name="dev_addr" type="byte"/>
        <option name="number_of_coils" type="unsigned int"/>
        <option name="coil_values" type="array bool 2000"/>
      </options>
      <responds_when>
        <match variable="address" value="$dev_addr"/>
      </responds_when>
      <transactions>
        <transaction name="read_coils">
          <match name="function_code" value="1"/>
          <set name="last_coil" value="(+ $starting_address $quantity_of_coils 1)"/>
          <conditional>
            <match_expr>(gt $last_coil $number_of_coils)</match_expr>
            <set name="exception_code" value="2"/>
          </conditional>
          <conditional>
            <match_expr>(== 0 (% $quantity_of_coils 8))</match_expr>
            <set name="byte_count" value="(/ $quantity_of_coils 8)"/>
          </conditional>
          <conditional>
            <isnset name="byte_count"/>
            <set name="byte_count" value="(+ 1 (/ $quantity_of_coils 8))"/>
          </conditional>
          <set name="coil_status" value="(pack_bool (substr $coil_values $starting_addres (+ 1 $loast_coil)))"/>
        </transaction>
      </transactions>
    </device>
  </devices>
  
</protocol>